# UI Sequence Diagrams

## Application Startup Sequence

```mermaid
sequenceDiagram
    participant User as Kullanıcı
    participant App as AppComponent
    participant MS as MainService
    participant SS as SyncService
    participant Auth as AuthService
    participant Router as Router

    User->>App: Uygulamayı başlat
    App->>MS: Constructor (DB init)
    MS->>MS: 28 DB oluştur (memory adapter)
    MS->>MS: RemoteDB bağlantısı (AuthInfo)
    MS->>MS: ServerDB bağlantısı (ServerSettings)
    
    App->>SS: appDataInitializer()
    SS->>MS: loadAppData()
    MS->>MS: allData'dan oku
    MS->>MS: LocalDB'lere dağıt
    
    App->>Auth: isAuthed()
    alt Giriş yapmamış
        Auth->>Router: Navigate to '/login'
    end
    
    alt Giriş yapmış
        Router->>Router: Navigate to '/home'
    end
```

## Login Flow

```mermaid
sequenceDiagram
    participant User as Kullanıcı
    participant UI as LoginComponent
    participant MS as MainService
    participant Auth as AuthService
    participant Router as Router
    participant DB as users DB

    User->>UI: PIN gir (4 haneli)
    UI->>UI: onClick(digit)
    
    Note over UI: 4 haneli birleşince
    
    UI->>MS: getAllBy('users', {pincode})
    MS->>DB: find(selector)
    DB-->>MS: user
    
    alt Kullanıcı bulundu
        MS-->>UI: user object
        UI->>Auth: login(user)
        Auth->>Auth: Set session
        UI->>Auth: setPermissions()
        UI->>Router: navigate()
        
        alt Fast Selling açık
            Router->>Router: /selling-screen/Fast/New
        else Normal
            Router->>Router: /store
        end
    else Kullanıcı bulunamadı
        UI->>UI: "Hatalı giriş"
        UI->>UI: clearDigits()
    end
```

## Selling Flow

```mermaid
sequenceDiagram
    participant Waiter as Garson
    participant UI as SellingScreen
    participant MS as MainService
    participant DB as LocalDB
    participant Printer as PrinterService
    participant Log as LogService

    Waiter->>UI: Ürün seç
    UI->>UI: selectProduct(product)
    UI->>UI: Ürünü sepete ekle
    
    Waiter->>UI: "Sipariş Ver" butonu
    UI->>MS: addData('orders', order)
    MS->>DB: orders.post()
    MS->>DB: allData.put()
    DB-->>MS: result
    
    UI->>MS: changeData('checks', check_id)
    MS->>DB: checks.upsert()
    MS->>DB: allData.upsert()
    
    alt Yazıcı ayarlı
        UI->>Printer: printOrder(device, table, orders)
        Printer->>IPC: send('printOrder')
        Note over IPC: Mutfak fişi yazdır
    end
    
    alt Stok takibi açık
        UI->>MS: addData('stocks', stock)
        MS->>DB: stocks.post()
    end
    
    UI->>Log: log('Sipariş verildi')
    UI->>Waiter: "Sipariş alındı"
```

## Payment Flow

```mermaid
sequenceDiagram
    participant Cashier as Kasiyer
    participant UI as PaymentScreen
    participant MS as MainService
    participant DB as LocalDB
    participant Printer as PrinterService
    participant Cashbox as Cashbox DB

    Cashier->>UI: Ödeme yöntemi seç
    UI->>UI: selectPaymentMethod(method)
    
    Cashier->>UI: Tutar gir / Tam Ödeme
    UI->>UI: calculateTotal()
    
    Cashier->>UI: "Ödeme Al" butonu
    UI->>MS: getData('checks', check_id)
    MS->>DB: checks.get(id)
    DB-->>MS: check
    
    UI->>MS: updateData('checks', check_id, payment_flow)
    MS->>DB: checks.put()
    
    UI->>MS: addData('cashbox', cashbox)
    MS->>DB: cashbox.post()
    
    UI->>MS: addData('closed_checks', check)
    MS->>DB: closed_checks.post()
    
    UI->>MS: removeData('checks', check_id)
    MS->>DB: checks.remove(id)
    MS->>DB: allData.remove(id)
    
    alt Fiş yazdırma aktif
        UI->>Printer: printCheck(device, check)
        Printer->>IPC: send('printCheck')
        UI->>Printer: printPayment(device, payment)
        Printer->>IPC: send('printPayment')
    end
    
    alt Nakit ödeme
        UI->>Printer: kickCashdraw(device)
        Printer->>IPC: send('kickCashdraw')
        Note over IPC: Kasa çekmecesi açılır
    end
    
    UI->>Cashier: "Ödeme alındı"
    UI->>UI: navigate('/store')
    Note over UI: Masa boşaltıldı
```

## End of Day Flow

```mermaid
sequenceDiagram
    participant Manager as Müdür
    participant UI as EndofthedayComponent
    participant DMS as DayManagementService
    participant MS as MainService
    participant DB as LocalDB
    participant Printer as PrinterService
    participant Sync as SyncService

    Manager->>UI: Gün Sonu ekranı
    UI->>MS: getAllBy('checks', {})
    MS->>DB: checks.find()
    DB-->>MS: all checks
    
    UI->>MS: getAllBy('cashbox', {})
    MS->>DB: cashbox.find()
    DB-->>MS: all cashbox movements
    
    UI->>UI: calculateTotals()
    Note over UI: Toplam ciro, nakit, kredi kartı
    
    alt Gün başlatma
        Manager->>UI: "Günü Başlat" butonu
        Manager->>UI: Açılış tutarı gir
        
        UI->>DMS: startDay(openingAmount)
        DMS->>MS: addData('endday', dayRecord)
        DMS->>MS: changeData('settings', 'DayInfo')
        DMS->>MS: changeData('settings', 'DayStatus')
        
        Note over DayStatus: started = true
        UI->>Manager: "Gün başlatıldı"
    end
    
    alt Gün kapatma
        Manager->>UI: "Günü Kapat" butonu
        
        UI->>MS: getAllBy('closed_checks', {})
        UI->>MS: getAllBy('endday', {})
        
        UI->>UI: generateEndOfDayReport()
        
        UI->>DMS: closeDay(endOfDayData)
        DMS->>MS: addData('endday', endOfDayRecord)
        
        UI->>Printer: printEndDay(device, data)
        Printer->>IPC: send('printEndDay')
        Note over IPC: Z-raporu yazdır
        
        UI->>Sync: cancel()
        Sync->>MS: syncToServer().cancel()
        Sync->>MS: syncToRemote().cancel()
        
        UI->>IPC: send('closeServer')
        Note over IPC: Express server kapat
        
        UI->>MS: changeData('settings', 'DayStatus')
        Note over DayStatus: started = false
        
        UI->>Manager: "Gün kapatıldı"
    end
```

## Real-time Updates (Changes Feed)

```mermaid
sequenceDiagram
    participant User as Kullanıcı A
    participant User2 as Kullanıcı B
    participant UI as StoreComponent
    participant MS as MainService
    participant DB as LocalDB

    User->>UI: Masa seç
    UI->>MS: changeData('tables', table_id, {status: 1})
    MS->>DB: tables.upsert()
    MS->>DB: allData.upsert()
    
    DB->>DB: Changes Feed trigger
    DB->>UI: change event (tables)
    
    UI->>MS: getAllBy('tables', {})
    MS->>DB: tables.find()
    DB-->>UI: updated tables
    
    UI->>UI: Refresh table grid
    Note over UI: Masa dolu olarak gösterilir
    
    par User2 views same page
        User2->>UI: Store page açık
        DB->>UI: change event (tables)
        UI->>UI: Auto-refresh
        Note over UI: User2 de güncellemeyi görür
    end
```
