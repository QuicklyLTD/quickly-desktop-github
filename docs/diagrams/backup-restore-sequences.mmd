# Backup and Restore Sequence Diagrams

## 1. End-of-Day Backup Process

```mermaid
sequenceDiagram
    participant User
    participant EOD as EndofthedayComponent
    participant Main as MainService
    participant Local as LocalDBs
    participant All as allData
    participant Electron as ElectronService
    participant HTTP as HttpService
    participant Cloud as hq.quickly.com.tr

    User->>EOD: Click "Gün Sonu" (End Day)
    EOD->>Main: getAllBy('checks', {})
    Main-->>EOD: Check count
    
    alt Open checks exist
        EOD-->>User: Alert: "Ödenmesi alınmamış hesaplar var!"
    else No open checks
        Note over EOD: Initialize EndDay report
        EOD->>EOD: backupData = []
        
        Note over EOD,Local: Step 1: Backup Checks
        EOD->>Main: getAllBy('closed_checks', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('closed_checks', docs)
        EOD->>EOD: Calculate sales totals
        EOD->>Main: removeAll('closed_checks')
        Main->>Local: destroy & recreate
        EOD->>Main: removeAll('allData', {db_name: 'closed_checks'})
        Main->>All: remove docs
        
        Note over EOD,Local: Step 2: Backup Cashbox
        EOD->>Main: getAllBy('cashbox', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('cashbox', docs)
        EOD->>EOD: Calculate income/outcome
        EOD->>Main: removeAll('cashbox')
        EOD->>Main: removeAll('allData', {db_name: 'cashbox'})
        
        Note over EOD,Local: Step 3: Backup Reports
        EOD->>Main: getAllBy('reports', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('reports', docs)
        EOD->>EOD: Reset activity arrays
        EOD->>Main: localSyncBeforeRemote('reports')
        
        Note over EOD,Local: Step 4: Backup Logs
        EOD->>Main: getAllBy('logs', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('logs', docs)
        EOD->>Main: removeAll('logs', 'prints')
        EOD->>Main: removeAll('allData', {db_name: 'logs'})
        
        Note over EOD,Local: Step 5: Backup Orders
        EOD->>Main: getAllBy('orders', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('orders', docs)
        EOD->>Main: removeAll('orders')
        EOD->>Main: removeAll('allData', {db_name: 'orders'})
        
        Note over EOD,Local: Step 6: Backup Receipts
        EOD->>Main: getAllBy('receipts', {})
        Main-->>EOD: docs
        EOD->>EOD: new BackupData('receipts', docs)
        EOD->>Main: removeAll('receipts')
        EOD->>Main: removeAll('allData', {db_name: 'receipts'})
        
        Note over EOD,Cloud: Step 7: Finalize and Upload
        EOD->>Main: addData('endday', endDayReport)
        EOD->>Electron: backupData(backupData, timestamp)
        Electron->>Electron: Write data/backup/{timestamp}
        EOD->>EOD: Print end day report
        EOD->>Main: syncToRemote().cancel()
        EOD->>HTTP: POST /store/backup
        HTTP->>Cloud: Upload backupData
        Cloud-->>HTTP: Response
        
        alt Upload success
            EOD->>Main: getAllBy('allData', {})
            Main-->>EOD: All docs
            EOD->>Electron: writeFile(data/db.dat)
            EOD->>HTTP: POST /store/refresh
            HTTP-->>EOD: New token
            
            Note over EOD,Cloud: Step 8: Purge and Reset
            EOD->>HTTP: POST /store/endday
            HTTP->>Cloud: Send all docs
            Cloud-->>HTTP: Verification OK
            EOD->>Main: destroyDB(all except settings)
            Main->>Local: Destroy 27 DBs
            EOD->>Main: initDatabases()
            Main->>Local: Create 27 DBs
            EOD->>Main: replicateFrom()
            Main->>All: Pull from RemoteDB
            All-->>Local: syncToLocal() updates
            EOD->>Electron: relaunchProgram()
        else Upload failed
            EOD->>EOD: Continue with local backup
            EOD->>Electron: writeFile(data/db.dat)
            EOD->>Electron: relaunchProgram()
        end
    end
```

## 2. Local Backup File Creation

```mermaid
sequenceDiagram
    participant EOD as EndofthedayComponent
    participant Electron as ElectronService
    participant FS as FileSystem
    participant File as Backup File

    EOD->>Electron: backupData(backupData, timestamp)
    
    Note over Electron,FS: Prepare backup directory
    Electron->>FS: exists(data/backup/)
    
    alt Directory doesn't exist
        FS-->>Electron: false
        Electron->>FS: mkdir(data/backup/)
        FS-->>Electron: Created
    else Directory exists
        FS-->>Electron: true
    end
    
    Note over Electron,File: Write backup file
    Electron->>Electron: JSON.stringify(backupData)
    Electron->>FS: writeFile(data/backup/{timestamp}, json)
    FS->>File: Write JSON array
    File-->>FS: Written
    FS-->>Electron: Done
    
    Note over File: File content
    File->>File: [{database: 'closed_checks', docs: [...]}, ...]
```

## 3. Full DB Snapshot (db.dat)

```mermaid
sequenceDiagram
    participant EOD as EndofthedayComponent
    participant Main as MainService
    participant All as allData
    participant Electron as ElectronService
    participant File as db.dat

    EOD->>Main: getAllBy('allData', {})
    Main->>All: allDocs({include_docs: true})
    All-->>Main: All documents
    Main-->>EOD: docs array
    
    Note over EOD: Clean documents
    EOD->>EOD: Map: delete _rev from each doc
    EOD->>EOD: cleanDocs array
    
    Note over EOD,File: Write snapshot
    EOD->>EOD: JSON.stringify(cleanDocs)
    EOD->>Electron: writeFile(data/db.dat, json)
    Electron->>File: Write all docs
    File-->>Electron: Written
    Electron-->>EOD: Success
    
    Note over File: db.dat content
    File->>File: [{_id: 'xxx', db_name: 'users', ...}, ...]
```

## 4. Cloud Backup Upload

```mermaid
sequenceDiagram
    participant EOD as EndofthedayComponent
    participant HTTP as HttpService
    participant Cloud as hq.quickly.com.tr
    participant Auth as Auth Server

    EOD->>EOD: Prepare payload
    Note over EOD: {data: backupData, timestamp: 1736659200000}
    
    EOD->>HTTP: post('/store/backup', payload, token)
    HTTP->>HTTP: Set headers
    Note over HTTP: Authorization: Bearer {token}
    Note over HTTP: Content-Type: application/json
    
    HTTP->>Cloud: POST request
    Cloud->>Auth: Verify token
    Auth-->>Cloud: Token valid
    Cloud->>Cloud: Parse backupData
    Cloud->>Cloud: Store in database
    
    alt Upload success
        Cloud-->>HTTP: 200 OK
        HTTP-->>EOD: res.ok = true
        EOD->>EOD: Continue to coverData()
    else Upload failed
        Cloud-->>HTTP: 401/403/500 Error
        HTTP-->>EOD: Error
        EOD->>EOD: Show alert, continue anyway
    end
```

## 5. Manual Restore from Backup

```mermaid
sequenceDiagram
    participant Admin
    participant Sync as SyncService
    participant Main as MainService
    participant All as allData
    participant Electron as ElectronService
    participant File as db.dat

    Admin->>Sync: loadFromBackup()
    Sync->>Electron: readFile('./data/db.dat')
    Electron->>File: Read file
    File-->>Electron: Buffer data
    Electron-->>Sync: data buffer
    
    alt File read success
        Sync->>Sync: data.toString('utf-8')
        Sync->>Sync: JSON.parse(data)
        Sync->>Sync: rdata (document array)
        
        Note over Sync,All: Destroy current DB
        Sync->>Main: destroyDB('allData')
        Main->>All: Destroy allData DB
        All-->>Main: {ok: true}
        Main-->>Sync: Destroyed
        
        Note over Sync,All: Reinitialize and load
        Sync->>Main: initDatabases()
        Main->>All: Create new allData
        All-->>Main: Ready
        
        Sync->>Sync: Wait 2.5 seconds
        Sync->>Main: putAll('allData', rdata)
        Main->>All: Bulk insert docs
        All-->>Main: Inserted
        
        alt Insert success
            Main-->>Sync: Success
            Sync->>Electron: reloadProgram()
        else Insert error
            Main-->>Sync: Error
            Sync->>Electron: reloadProgram() anyway
        end
    else File read error
        Electron-->>Sync: err
        Sync->>Sync: console.error('Backup file read error')
        Sync-->>Admin: Restore failed
    end
```

## 6. End-of-Day Purge and Reset

```mermaid
sequenceDiagram
    participant EOD as EndofthedayComponent
    participant Main as MainService
    participant All as allData
    participant Local as LocalDBs
    participant HTTP as HttpService
    participant Cloud as hq.quickly.com.tr
    participant Electron as ElectronService

    EOD->>Main: getAllBy('allData', {})
    Main-->>EOD: All documents
    
    Note over EOD,Cloud: Send to cloud for verification
    EOD->>HTTP: POST /store/endday, docs
    HTTP->>Cloud: Upload all docs
    Cloud->>Cloud: Verify and store
    Cloud-->>HTTP: 200 OK
    HTTP-->>EOD: resPost.ok = true
    
    Note over EOD,Local: Destroy all DBs except settings
    EOD->>EOD: databasesArray = [users, checks, orders, ...]
    EOD->>Main: destroyDB(databasesArray)
    
    loop For each DB (27 DBs)
        Main->>Local: Destroy DB
        Local-->>Main: {ok: true}
    end
    Main-->>EOD: All destroyed
    
    Note over EOD,Local: Reinitialize DBs
    EOD->>EOD: Wait 2 seconds
    EOD->>Main: initDatabases()
    
    loop For each DB (27 DBs)
        Main->>Local: Create new PouchDB
        Local-->>Main: Created
    end
    Main-->>EOD: All initialized
    
    Note over EOD,All: Replicate from cloud
    EOD->>EOD: Wait 3 seconds
    EOD->>Main: replicateFrom()
    Main->>All: Pull from RemoteDB
    All-->>Main: Docs replicated
    
    Note over EOD,Local: Update LocalDBs
    Main->>All: changes({since: 'now'})
    All-->>Main: Change feed
    loop For each doc
        Main->>Local: put(doc)
    end
    
    Note over EOD,Electron: Reload program
    EOD->>Electron: relaunchProgram()
    Electron->>Electron: app.relaunch()
```

## 7. Remote Replication After Purge

```mermaid
sequenceDiagram
    participant EOD as EndofthedayComponent
    participant Main as MainService
    participant All as allData
    participant Remote as RemoteDB (Cloud)
    participant Local as LocalDBs

    EOD->>Main: replicateFrom()
    
    Note over Main,Remote: One-way replication
    Main->>Remote: replicate.to(allData)
    Remote->>Remote: Prepare changes
    Remote->>All: Stream documents
    
    loop For each batch
        Remote-->>All: Docs batch
        All->>All: put(docs)
    end
    
    All-->>Main: Replication complete
    
    Note over All,Local: Update LocalDBs
    Main->>All: syncToLocal()
    All->>All: changes({since: 'now', live: false})
    
    loop For each change
        All-->>Main: {doc, db_name}
        Main->>Main: delete doc._rev
        Main->>Local: put(doc)
    end
    
    Main-->>EOD: Sync complete
    EOD->>EOD: Ready for new day
```

## 8. Backup Data Flow

```mermaid
sequenceDiagram
    participant Daily as Daily Operations
    participant Local as LocalDBs
    participant Backup as Backup Process
    participant LocalFile as Local Files
    participant Cloud as Cloud Backup
    participant Purge as Purge Process
    participant Fresh as Fresh Start

    Daily->>Local: CRUD operations
    Local->>Local: Store data
    
    Note over Backup: End of Day Trigger
    Backup->>Local: getAllBy() for 6 DBs
    Local-->>Backup: Documents
    
    par Parallel backup
        Backup->>LocalFile: Write data/backup/{timestamp}
        and
        Backup->>Cloud: Upload via HTTP
    end
    
    Backup->>Local: removeAll() for 6 DBs
    Local->>Local: Clear data
    
    Note over Purge: Prepare for reset
    Purge->>Local: getAllBy('allData')
    Local-->>Purge: All docs
    Purge->>Cloud: Send for verification
    Cloud-->>Purge: Verified
    
    Purge->>Local: Destroy 27 DBs
    Purge->>Local: Reinitialize 27 DBs
    Purge->>Cloud: replicateFrom()
    Cloud-->>Local: Fresh data
    
    Fresh->>Local: Ready for new day
```

## Key Points

### Backup Process
- **7 Steps**: Sequential backup of 6 DBs + finalize
- **Dual Storage**: Local files + Cloud upload
- **Progress Tracking**: User feedback via `progress` string
- **Error Resilient**: Continues even if cloud fails

### Restore Process
- **Manual Trigger**: Admin-initiated restore
- **Full Replacement**: Destroy allData, load from db.dat
- **Automatic**: Post-purge replication from cloud
- **Fresh Start**: Clean slate after end-of-day

### Data Flow
- **LocalDBs → allData**: Dual-write pattern
- **allData → Backup**: JSON serialization
- **Backup → Cloud**: HTTP upload
- **Cloud → allData**: Post-purge replication
- **allData → LocalDBs**: syncToLocal() update

### Timing
- **Backup**: 20-30 seconds (6 DBs)
- **Cloud Upload**: 5-10 seconds (network dependent)
- **Purge**: 5 seconds (destroy + init)
- **Replication**: 5-10 seconds (pull from cloud)
- **Total**: 30-45 seconds for full EOD
